<!DOCTYPE html>
<html>
<head>
    <title>Barcode Splitter</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 0 20px;
            background: #f7f9fc;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        h2 { text-align: center; color: #1a237e; margin-bottom: 20px; transition: color 0.3s; }

        /* Drag & drop area */
        #dropArea {
            width: 100%;
            padding: 40px;
            border: 2px dashed #1a237e;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            color: #1a237e;
            margin-bottom: 15px;
            transition: background 0.3s, border-color 0.3s;
        }
        #dropArea.hover { background: #e3f2fd; border-color: #3949ab; }

        textarea { width: 100%; height: 150px; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 14px; resize: vertical; transition: all 0.2s; }
        textarea:focus { border-color: #1a237e; outline: none; box-shadow: 0 0 8px rgba(26,35,126,0.3); }

        button { padding: 12px 25px; font-size: 16px; margin-top: 10px; margin-right: 10px; border: none; border-radius: 8px; background: linear-gradient(90deg, #1a237e, #3949ab); color: white; cursor: pointer; transition: all 0.2s; }
        button:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        #recordCount { margin-top: 10px; font-weight: bold; transition: color 0.3s; }

        #progressContainer { width: 100%; background-color: #e0e0e0; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; display: none; overflow: hidden; transition: all 0.3s; }
        #progressBar { width: 0%; height: 24px; background: linear-gradient(90deg,#1a237e,#3949ab); text-align: center; color: white; line-height: 24px; border-radius: 8px; transition: width 0.3s; }

        /* Dark mode */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode h2 { color: #90caf9; }
        body.dark-mode textarea { background: #1e1e1e; color: #e0e0e0; border-color: #3949ab; }
        body.dark-mode #recordCount { color: #90caf9; }
        body.dark-mode #dropArea { border-color: #90caf9; color: #90caf9; }
        body.dark-mode #progressContainer { background: #333; border-color: #3949ab; }
        body.dark-mode #progressBar { background: linear-gradient(90deg,#3949ab,#1a237e); }

        /* Dark mode toggle */
        #darkToggle { float: right; margin-top: -40px; margin-bottom: 20px; cursor: pointer; font-size: 14px; background: none; border: none; color: #1a237e; font-weight: bold; transition: color 0.3s; }
        #darkToggle:hover { color: #3949ab; }
        body.dark-mode #darkToggle { color: #90caf9; }
    </style>
</head>
<body>

<h2>Barcode Splitter</h2>

<button id="darkToggle">ðŸŒ™ Dark Mode</button>

<div id="dropArea">ðŸ“‚ Sleep je CSV of Excel bestand hierheen of klik om te selecteren</div>

<form id="barcodeForm">
    <textarea id="barcodeInput" name="barcodes" placeholder="Of plak hier barcodes, Ã©Ã©n per regel"></textarea>
    <div id="recordCount">Records: 0</div>

    <div id="progressContainer">
        <div id="progressBar">0%</div>
    </div>

    <button type="submit">Verwerken & Download Excel</button>
    <button type="button" id="resetBtn">Reset</button>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.0/xlsx.full.min.js"></script>
<script>
    const barcodeInput = document.getElementById("barcodeInput");
    const recordCount = document.getElementById("recordCount");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const form = document.getElementById("barcodeForm");
    const resetBtn = document.getElementById("resetBtn");
    const darkToggle = document.getElementById("darkToggle");
    const dropArea = document.getElementById("dropArea");
    const body = document.body;

    // Update record count live
    function updateRecordCount() {
        const lines = barcodeInput.value.split(/\r?\n/).filter(l => l.trim() !== "");
        recordCount.textContent = `Records: ${lines.length}`;
    }
    barcodeInput.addEventListener("input", updateRecordCount);

    // Reset button
    resetBtn.addEventListener("click", () => {
        barcodeInput.value = "";
        updateRecordCount();
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        barcodeInput.focus();
    });

    // Dark mode toggle
    darkToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        darkToggle.textContent = body.classList.contains("dark-mode") ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
    });

    // Drag & drop
    dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.classList.add("hover"); });
    dropArea.addEventListener("dragleave", e => { e.preventDefault(); dropArea.classList.remove("hover"); });
    dropArea.addEventListener("drop", e => {
        e.preventDefault();
        dropArea.classList.remove("hover");
        const file = e.dataTransfer.files[0];
        handleFile(file);
    });
    dropArea.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".csv, .xlsx";
        input.onchange = () => handleFile(input.files[0]);
        input.click();
    });

    function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        const ext = file.name.split(".").pop().toLowerCase();
        reader.onload = function(e) {
            let barcodes = [];
            if (ext === "csv") {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                lines.forEach(line => {
                    const cols = line.split(",");
                    if (cols[0]?.trim()) barcodes.push(cols[0].trim());
                });
            } else if (ext === "xlsx") {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: "array" });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                json.forEach(row => { if (row[0]?.toString().trim()) barcodes.push(row[0].toString().trim()); });
            } else {
                alert("Alleen CSV of Excel bestanden zijn toegestaan!");
                return;
            }
            barcodeInput.value = barcodes.join("\n");
            updateRecordCount();
        };
        if (ext === "csv") reader.readAsText(file);
        else if (ext === "xlsx") reader.readAsArrayBuffer(file);
    }

    // Form submit
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const lines = barcodeInput.value.split(/\r?\n/).filter(l => l.trim() !== "");
        if (lines.length === 0) { alert("Geen barcodes!"); return; }

        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";

        const formData = new FormData();
        formData.append("barcodes", barcodeInput.value);

        const response = await fetch("/export", { method: "POST", body: formData });

        let progress = 0;
        const interval = setInterval(() => { if(progress<90){progress+=10;progressBar.style.width=progress+"%";progressBar.textContent=progress+"%";} }, 100);

        const blob = await response.blob();
        clearInterval(interval);
        progressBar.style.width="100%";
        progressBar.textContent="100%";

        const filenameHeader = response.headers.get("Content-Disposition") || "";
        let filename="Export.xlsx";
        if (filenameHeader.includes("filename=")) filename = filenameHeader.split("filename=")[1];

        const link=document.createElement("a");
        link.href=window.URL.createObjectURL(blob);
        link.download=filename;
        link.click();

        setTimeout(()=>{progressContainer.style.display="none";progressBar.style.width="0%";progressBar.textContent="0%";},1500);
    });

</script>

</body>
</html>
